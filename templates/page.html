{% extends 'base.html' %} {% load static %} {% block content %}
<div>
  <link rel="stylesheet" href="{% static 'css/my-grapesjs.css' %}" />

  <form class="flex flex-col items-center justify-center" method="POST" action="{% url 'index' %}?{{page.id}}">
    {% csrf_token %}
    <div class="lg:w-1/3 md:w-1/2 bg-white rounded-lg p-8 flex flex-col w-full mt-10 md:mt-0 z-10 shadow-md">
        <h2 class="text-gray-900 text-lg mb-1 font-medium title-font">Criar Página</h2>
        <div class="relative mb-4">
            <label for="name" class="leading-7 text-sm text-gray-600">Nome</label>
            <input type="text"
                   id="name"
                   value="{{page.name}}"
                   name="name"
                   required
                   class="w-full bg-white rounded border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 text-base outline-none text-gray-700 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out">
        </div>
        <input type="hidden" id="page_id" value="{{page.id}}" />
        <textarea required id="content" name="content" style="display: none">{{page.content|safe}}</textarea>
        <button type="submit" class="text-white bg-indigo-500 border-0 py-2 px-6 focus:outline-none hover:bg-indigo-600 rounded text-lg">
            {% if page %}
            Salvar
            {% else %}
            Criar
            {% endif %}
        </button>
    </div>
    
  </form>

  <br/>

  <div class="panel__top">
    <div class="panel__basic-actions"></div>
    <div class="panel__devices"></div>
    <div class="panel__switcher"></div>
  </div>
  <div class="editor-row">
    <div class="editor-canvas">
      <div id="gjs">
        {{page.content | safe}}
      </div>
    </div>
    <div class="panel__right">
      <div class="layers-container"></div>
      <div class="styles-container"></div>
      <div class="traits-container"></div>
      <div id="blocks"></div>
    </div>
  </div>
  <script src="{% static 'js/grapesjs-config.js' %}"></script>
  <script>
    {% for component in components %}
    editor.BlockManager.add('{{component.html_id}}', {
        label: '{{component.label}}',
        category: '{{component.category}}',
        content: `{{component.content|safe}}`,
        attributes: {% if component.attribbutes %} {{component.attributes | safe}} {% else %}
        null {% endif %},
    });
    {% endfor %}


    editor.Storage.add('remote', {
        {% comment %} async load() {

        }, {% endcomment %}

        
        async store(data) {

            const htmlContent = editor.getHtml();
            
            document.getElementById('content').innerText  = htmlContent;
        },
      });

      {% comment %} document.getElementById('saveBtn').addEventListener('click', function() {
        const htmlContent = editor.getHtml();
        fetch('/save_page/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}' // Se você não estiver usando @csrf_exempt
            },
            body: 'content=' + encodeURIComponent(htmlContent)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Conteúdo salvo com sucesso!');
            } else {
                alert('Falha ao salvar o conteúdo: ' + data.message);
            }
        })
        .catch(error => console.error('Erro:', error));
    }); {% endcomment %}
  </script>
</div>
{% endblock content %}
